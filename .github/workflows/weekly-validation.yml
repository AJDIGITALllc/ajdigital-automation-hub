name: AJDIGITAL Weekly Validation

on:
  schedule:
    # every Sunday at 06:00 UTC
    - cron: "0 6 * * 0"
  workflow_dispatch:

jobs:
  validate-and-update:
    runs-on: ubuntu-latest

    permissions:
      contents: write   # needed so we can push dashboard updates

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Run validation + dashboard generation
        run: |
          echo "Running AJDIGITAL validation..."
          python scripts/validate_repos.py

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit dashboard if changed
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git add docs/status-dashboard.md .github/workflows/validate.yml .ajdlink.yaml || true
            git commit -m "chore: weekly dashboard refresh"
            git push origin HEAD:main
          else
            echo "No changes to commit."
          fi

      - name: Post validation summary
        run: |
          echo "### ✅ AJDIGITAL Weekly Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date (UTC):** $(date -u '+%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_STEP_SUMMARY
          # count how many lines in the dashboard have ✅ (roughly: repos validated)
          COUNT=$(grep -c "✅" docs/status-dashboard.md || echo 0)
          echo "**Repositories validated:** $COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Dashboard file:_ [docs/status-dashboard.md](./docs/status-dashboard.md)" >> $GITHUB_STEP_SUMMARY